# Apply with:
# ansible-playbook -i 192.168.56.200, ./playbooks/finalization.yml 
# -u vagrant   --private-key .vagrant/machines/ctrl/virtualbox/private_key 
#  -e "ansible_ssh_common_args='-o StrictHostKeyChecking=no'"   -e ansible_ssh_timeout=60
# After running the default playbooks

- hosts: all
  gather_facts: false
  become: true
  tasks:
    - name: Copy MetalLB Manifest
      copy:
        src: ../libs/metallb-native.yaml
        dest: /tmp/metallb-native.yaml
        owner: vagrant
        group: vagrant
        mode: '0644'
  
    - name: Install MetalLB
      environment:
        KUBECONFIG: /mnt/shared/admin.conf
      command: kubectl apply --validate=false -f /tmp/metallb-native.yaml

    - name: Wait for MetalLB controller deployment
      environment:
        KUBECONFIG: /mnt/shared/admin.conf
      command: >
        kubectl rollout status deployment/controller
        -n metallb-system
        --timeout=300s

        
    - name: Create IPAddressPool
      copy:
        dest: /tmp/ippool.yaml
        content: |
          apiVersion: metallb.io/v1beta1
          kind: IPAddressPool
          metadata: 
            name: default-ippool
            namespace: metallb-system
          spec:
            addresses: 
              - 192.168.56.90-192.168.56.99     
              
    - name: Apply IPAddressPool
      environment:
        KUBECONFIG: /mnt/shared/admin.conf
      command: kubectl apply -f /tmp/ippool.yaml
              
    - name: Create L2Advertisement 
      copy:
        dest: /tmp/l2adv.yaml
        content: |
          apiVersion: metallb.io/v1beta1
          kind: L2Advertisement
          metadata: 
            name: default-advertisement
            namespace: metallb-system
          spec:
            ipAddressPools:
              - default-ippool        
              
    - name: Apply L2Advertisement
      environment:
        KUBECONFIG: /mnt/shared/admin.conf
      command: kubectl apply -f /tmp/l2adv.yaml

    # Assignment 2: Step 21
    - name: Add ingress-nginx repository
      kubernetes.core.helm_repository:
        name: ingress-nginx
        repo_url: "https://kubernetes.github.io/ingress-nginx"

    - name: Install ingress-nginx chart
      environment:
        KUBECONFIG: /mnt/shared/admin.conf
      kubernetes.core.helm:
        name: ingress-nginx
        chart_ref: ingress-nginx/ingress-nginx
        create_namespace: true
        release_namespace: ingress-nginx
        values:
          controller:
            service:
              enabled: true
              type: LoadBalancer
              loadBalancerIP: 192.168.56.93

    - name: Wait for ingress-nginx controller to be ready
      environment:
        KUBECONFIG: /home/vagrant/.kube/config
      command: >
        kubectl wait --for=condition=ready pod
        -l app.kubernetes.io/component=controller
        -n ingress-nginx
        --timeout=120s

    # Assignment 2: Step 22
    - name: Add Kubernetes Dashboard Helm repo
      kubernetes.core.helm_repository:
        name: kubernetes-dashboard
        repo_url: https://kubernetes.github.io/dashboard/

    - name: Install Kubernetes Dashboard chart
      environment:
        KUBECONFIG: /mnt/shared/admin.conf
      kubernetes.core.helm:
        name: kubernetes-dashboard
        chart_ref: kubernetes-dashboard/kubernetes-dashboard
        release_namespace: kubernetes-dashboard
        create_namespace: true
    
    - name: Copy Kubernetes Dashboard Admin User Manifest
      copy:
        src: ../libs/kubernetes-dashboard-adminuser.yml
        dest: /tmp/kubernetes-dashboard-adminuser.yml
        owner: vagrant
        group: vagrant
        mode: '0644'

    - name: Create Admin User
      environment:
        KUBECONFIG: /mnt/shared/admin.conf
      command: kubectl apply -f /tmp/kubernetes-dashboard-adminuser.yml


    - name: Copy Kubernetes Dashboard Ingress Manifest
      copy:
        src: ../libs/kubernetes-dashboard-ingress.yml
        dest: /tmp/kubernetes-dashboard-ingress.yml
        owner: vagrant
        group: vagrant
        mode: '0644'
    
    - name: Wait for ingress-nginx controller deployment
      environment:
        KUBECONFIG: /mnt/shared/admin.conf
      command: >
        kubectl rollout status deployment/ingress-nginx-controller
        -n ingress-nginx
        --timeout=300s

    - name: Apply Kubernetes Dashboard Ingress
      environment:
        KUBECONFIG: /mnt/shared/admin.conf
      command: kubectl apply -f /tmp/kubernetes-dashboard-ingress.yml

    # Assignment 2: Step 23 - Install Istio
    - name: Check if Istio is already downloaded
      stat:
        path: /home/vagrant/istio-1.25.2
      register: istio_dir

    - name: Download Istio 1.25.2
      get_url:
        url: https://github.com/istio/istio/releases/download/1.25.2/istio-1.25.2-linux-amd64.tar.gz
        dest: /tmp/istio-1.25.2-linux-amd64.tar.gz
        mode: '0644'
      when: not istio_dir.stat.exists

    - name: Extract Istio
      unarchive:
        src: /tmp/istio-1.25.2-linux-amd64.tar.gz
        dest: /home/vagrant/
        remote_src: yes
        owner: vagrant
        group: vagrant
      when: not istio_dir.stat.exists

    - name: Add istioctl to PATH in .bashrc
      lineinfile:
        path: /home/vagrant/.bashrc
        line: 'export PATH="$PATH:/home/vagrant/istio-1.25.2/bin"'
        state: present
        create: yes

    - name: Create Istio operator config for fixed gateway IP
      copy:
        dest: /tmp/istio-config.yaml
        content: |
          apiVersion: install.istio.io/v1alpha1
          kind: IstioOperator
          spec:
            components:
              ingressGateways:
                - name: istio-ingressgateway
                  enabled: true
                  k8s:
                    service:
                      type: LoadBalancer
                      loadBalancerIP: 192.168.56.94

    - name: Check if Istio is already installed
      environment:
        KUBECONFIG: /mnt/shared/admin.conf
      shell: kubectl get ns istio-system
      register: istio_ns_check
      failed_when: false
      changed_when: false

    - name: Install Istio with custom config
      environment:
        KUBECONFIG: /mnt/shared/admin.conf
        PATH: "/home/vagrant/istio-1.25.2/bin:{{ ansible_env.PATH }}"
      command: istioctl install -y -f /tmp/istio-config.yaml
      when: istio_ns_check.rc != 0

    - name: Wait for Istio pods to be ready
      environment:
        KUBECONFIG: /mnt/shared/admin.conf
      command: >
        kubectl wait --for=condition=ready pod
        --all -n istio-system
        --timeout=300s
      when: istio_ns_check.rc != 0
